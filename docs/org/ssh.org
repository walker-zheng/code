
# -*- org -*-
# -*- coding:utf-8 -*-

# Time-stamp: <2016-07-23 14:29:03 (mykulou@gmail.com)>
#+SETUPFILE: theme-bigblow-local.setup

* ssh问题：
** config中设置:(保持共用连接)
     Host *
     ControlMaster auto
     ControlPath ~/.ssh/master-%r@%h:%p

** 公钥登陆
     生成密钥对：
     
     ssh-keygen -t rsa -b 1024
     默认生成~/.ssh/id_rsa和相应pub文件
     
     添加pub公钥内容到要登陆的目标主机~/.ssh/authorized_keys
     或执行ssh-copy-id user@hostname
     .ssh目录权限为700
     authorized_keys权限为600
     名称也不能错
     
     尝试登录，若返回Agent admitted failure to sign using the key
     则查看ssh-agent是否运行，
     执行ssh-add id_rsa添加私钥到agent
     
     
     
     sshd_config设置：
     
     打开RSA和publickey认证，关闭password认证
     StrictModes no
     修改默认端口
     
     日志级别(INFO, VERBOSE)、名称修改

** 为任何服务的端口建立隧道：
     client端要配置，forwarding的相应服务的本地和远端的端口
     server不需配置

** X11 转发:显示应用程序图形部分
     需要有X服务器（如cygwin-X）和ssh
     ssh server端，sshd_config中开启X11转发

     ssh client端，可能要配置ForwardX11 yes
     重启ssh会话

     安装配置启动X server

     
     X11 转发设置打开，可以通过ssh管理X窗口
     查看是否开启了X11 forwarding：
     set | grep DISP
     DISPLAY=localhost:10.0

     如无法开启的看是否安装了xorg-x11-xauth依赖包

** ssh一般用途：建立安全通信的隧道（一般是网络）
     1.shell访问
     2.替代rsh执行单条远端命令： ssh user@hostname reboot
     3.scp、sftp文件访问
     4.结合rsync有效安全的备份、复制和镜像
     rsync -avul --rsh=ssh /opt/data/ user@hostname:/home/
     5.端口转发和端口隧道化(不要与VPN混淆)
	 ssh -L 8000:mailserver:110 exmpale.com
     6.从远程主机转发X会话
	 ssh -X user@exmpale.com
	 一般设置sshd_config中的：
	 AllowTcpForwarding yes
	 X11Forwarding yes
     7.X11 转发配置与带ssh X11隧道的X客户端的结合，支持实现通过ssh安全的在win上运行一个linux子系统，
     win是linux远程主机的ssh会话来源
	 ssh -ND 8000 user@exmpale.com
     8.使用sshfs将一个目录作为本地的文件系统安全的挂在一个远程服务器上
     sshfs user@exmpale.com:/rdir /mnt/ldir
     9.通过一个或多个机制对服务器进行自动优化的远程主机管理和控制
	 ssh example.com ps -ef | grep httpd | wc -l

** ssh安全设置：
     PermitRootLogin no
     PermitEmptyPasswords no
     使用强大的密码和口令保护密钥对，不要没有口令
     配置tcp包装程序 /etc/hosts.deny
     在工作站和笔记本上卸载和删除ssh服务器
     控制用户访问：sshd_config中，AllowUsers、DenyUsers
     仅使用ssh v2： Protocol 2
     不支持闲置会话，设置超时：
	 ClientAliveInterval 600		# (Set to 600 seconds = 10 minutes)
	 ClientAliveCountMax 0
     禁用基于主机的身份验证和用户的.rhost
	 HostbasedAuthentication no
	 IgnoreRhosts yes
     配置防火墙iptables，限制未知ip
	 -A RH-FW-1-INPUT -s 192.168.100.0/24 -m state --state NEW -p tcp --dport 22 -j ACCEPT
     限制ssh监听接口    ListenAddress 192.168.100.17
     设置用户策略、使用强大的密码：
	 < /dev/urandom tr -dc A-Za-z0-9_ | head -c8
     设置sftp用户局限在自己主目录
	 ChrootDirectory /data01/home/%u
	 X11Forwarding no
	 AllowTcpForwarding no

**** 在指定时间内对传入ssh端口的连接的数量限速
       -A INPUT  -i eth0 -p tcp --dport 2022 -m state --state NEW -m limit --limit 3/min --limit-burst 3 -j ACCEPT
	   -A INPUT  -i eth0 -p tcp --dport 2022 -m state --state ESTABLISHED -j ACCEPT
	   -A OUTPUT -o eth0 -p tcp --sport 2022 -m state --state ESTABLISHED -j ACCEPT
**** 限制同时的连接到ssh的数量
       -I INPUT -p tcp --dport 2022 -i eth0 -m state --state NEW -m recent --set
	   -I INPUT -p tcp --dport 2022 -i eth0 -m state --state NEW -m recent --update --seconds 30 --hitcount 3 -j DR
**** 使用日志分析器，管理日志，如logcheck、loggrep、splunk 或 logwatch
       ssh日志级别 (INFO VERBOSE DEBUG)
       时常更新ssh相关补丁和依赖软件
       隐藏ssh版本，使用源码编译，增加配置：
       VerifyReverseMapping yes	# Turn on  reverse name checking
	   UsePrivilegeSeparation yes	# Turn on privilege separation
       删除系统中的rlogin和rsh，用ssh的symlink代替：

       ssh v2的身份验证方法，使用支持密码
       AllowedAuthentications publickey, password
       RequiredAuthentications publickey, password
* [[file:index.html][wiki]]
